<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kong Gateway Configuration Guide for Integrated API</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
            color: #333;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #003459;
            border-bottom: 3px solid #007ea7;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        h2 {
            color: #007ea7;
            margin-top: 40px;
            margin-bottom: 20px;
            border-left: 4px solid #00a8e8;
            padding-left: 15px;
        }
        h3 {
            color: #00a8e8;
            margin-top: 25px;
            margin-bottom: 15px;
        }
        h4 {
            color: #00c9a7;
            margin-top: 20px;
            margin-bottom: 12px;
        }
        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 15px 0;
            border-left: 4px solid #00a8e8;
        }
        .code-block code {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre;
        }
        .response-block {
            background: #f0f9ff;
            border-left: 4px solid #4caf50;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        .note {
            background: #fff9e6;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        .warning {
            background: #ffe6e6;
            border-left: 4px solid #f44336;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        .info {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        .success {
            background: #e0f7fa;
            border-left: 4px solid #00bcd4;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background: #007ea7;
            color: white;
        }
        tr:nth-child(even) {
            background: #f9f9f9;
        }
        .header-info {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 30px;
        }
        .step-number {
            display: inline-block;
            background: #007ea7;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            margin-right: 10px;
            font-weight: bold;
        }
        .quick-start {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 20px;
            border-radius: 8px;
            margin: 30px 0;
        }
        .quick-start h3 {
            color: #856404;
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Kong Gateway Configuration Guide for Integrated API</h1>
        
        <div class="header-info">
            <h2>üìã Prerequisites and Environment</h2>
            <table>
                <thead>
                    <tr>
                        <th>Component</th>
                        <th>Value</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>API Name</strong></td>
                        <td><code>integratedapi</code></td>
                        <td>Running on Kubernetes</td>
                    </tr>
                    <tr>
                        <td><strong>K8s Service</strong></td>
                        <td><code>integratedapi-service</code></td>
                        <td>Internal cluster DNS: <code>integratedapi-service.default.svc.cluster.local:7080</code></td>
                    </tr>
                    <tr>
                        <td><strong>Kong Admin Endpoint (with Ingress)</strong></td>
                        <td><code>http://kong-admin.local</code></td>
                        <td>Accessible via Ingress (no port-forward needed)</td>
                    </tr>
                    <tr>
                        <td><strong>Kong Proxy Endpoint (with Ingress)</strong></td>
                        <td><code>http://kong-proxy.local</code></td>
                        <td>Accessible via Ingress (no port-forward needed)</td>
                    </tr>
                    <tr>
                        <td><strong>API Port</strong></td>
                        <td><code>7080</code></td>
                        <td>The port your Kestrel application is listening on</td>
                    </tr>
                    <tr>
                        <td><strong>Final K8s Status</strong></td>
                        <td>3/3 Pods Running</td>
                        <td></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="quick-start">
            <h3>‚ö° Quick Start - Next Steps After Kong Installation</h3>
            <ol>
                <li><strong>Install Ingress Controller</strong> (if not already done)</li>
                <li><strong>Update hosts file</strong> to add kong-admin.local and kong-proxy.local</li>
                <li><strong>Verify Kong is accessible</strong> at http://kong-admin.local/status</li>
                <li><strong>Register your API service</strong> in Kong</li>
                <li><strong>Create routes</strong> for different endpoints (API, Swagger, Health)</li>
                <li><strong>Test endpoints</strong> through Kong Proxy</li>
                <li><strong>Access Swagger UI</strong> at http://kong-proxy.local/integratedapi/swagger/index.html</li>
            </ol>
        </div>

        <h2>üîß Step 0: Setup Ingress Controller (If Not Already Installed)</h2>
        
        <div class="note">
            <strong>Note:</strong> If you already have an Ingress Controller installed (like Nginx Ingress), skip this step. Otherwise, install it first.
        </div>

        <h3>Option A: Install NGINX Ingress Controller</h3>
        <div class="code-block">
            <code>kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.9.4/deploy/static/provider/cloud/deploy.yaml</code>
        </div>

        <h3>Option B: Enable Ingress for Docker Desktop/Minikube</h3>
        <p>For Minikube:</p>
        <div class="code-block">
            <code>minikube addons enable ingress</code>
        </div>
        
        <p>For Docker Desktop (Kubernetes), install manually with Option A above.</p>

        <h3>Verify Ingress Controller is Running</h3>
        <div class="code-block">
            <code>kubectl get pods -n ingress-nginx</code>
        </div>
        
        <div class="response-block">
            <strong>Expected Output:</strong> You should see pods with names like <code>ingress-nginx-controller-xxx</code> in <code>Running</code> state.
        </div>

        <h2>üåê Step 1: Deploy Kong with Ingress Resources</h2>
        
        <div class="info">
            <strong>‚úÖ Good News:</strong> Your <code>kong-integrated.yml</code> file has been updated to include Ingress resources. Simply apply or re-apply the updated YAML file.
        </div>

        <h3>Apply the Updated Kong Configuration</h3>
        <div class="code-block">
            <code>kubectl apply -f kong-integrated.yml</code>
        </div>

        <div class="response-block">
            <strong>What's Added:</strong> Two Ingress resources have been added to your Kong deployment:
            <ul>
                <li><code>kong-admin-ingress</code> - For Kong Admin API access</li>
                <li><code>kong-proxy-ingress</code> - For Kong Proxy access</li>
            </ul>
        </div>

        <h3>Wait for Kong to be Ready</h3>
        <div class="code-block">
            <code># Check Kong pod status
kubectl get pods -n kong

# Wait for all pods to be Running
# Expected: postgres-xxx, kong-xxx should be Running</code>
        </div>

        <h2>üîë Step 2: Configure Local DNS (hosts file)</h2>
        
        <p>To access Kong Admin and Proxy via friendly domain names, add entries to your hosts file:</p>

        <h3>Windows (Run PowerShell as Administrator)</h3>
        <div class="code-block">
            <code># Open Notepad as Administrator
notepad C:\Windows\System32\drivers\etc\hosts

# Add these lines at the end:
127.0.0.1 kong-admin.local
127.0.0.1 kong-proxy.local

# Save and close</code>
        </div>

        <h3>Linux/Mac</h3>
        <div class="code-block">
            <code>sudo nano /etc/hosts

# Add these lines:
127.0.0.1 kong-admin.local
127.0.0.1 kong-proxy.local

# Save with Ctrl+O, Exit with Ctrl+X</code>
        </div>

        <div class="note">
            <strong>Important:</strong> Save the hosts file after adding these entries. You may need to restart your browser or flush DNS cache for changes to take effect.
            <br><br>
            To flush DNS cache on Windows: <code>ipconfig /flushdns</code>
        </div>

        <h2>‚úÖ Step 3: Verify Ingress is Working</h2>

        <h3>Check Ingress Resources</h3>
        <div class="code-block">
            <code>kubectl get ingress -n kong</code>
        </div>

        <div class="response-block">
            <strong>Expected Output:</strong>
            <pre>NAME                 CLASS   HOSTS               ADDRESS     PORTS   AGE
kong-admin-ingress   nginx   kong-admin.local    localhost   80      5m
kong-proxy-ingress   nginx   kong-proxy.local    localhost   80      5m</pre>
        </div>

        <h3>Test Kong Admin Access</h3>
        <div class="code-block">
            <code># PowerShell
Invoke-RestMethod -Uri "http://kong-admin.local/status"

# Output should show Kong status with database: connected</code>
        </div>

        <div class="response-block">
            <strong>Expected Response:</strong>
            <pre>{
  "database": {
    "reachable": true
  },
  "memory": {
    ...
  },
  "server": {
    "connections_accepted": 1,
    "connections_active": 1,
    ...
  }
}</pre>
        </div>

        <h3>Test Kong Proxy Access (Before Routes)</h3>
        <div class="code-block">
            <code># PowerShell
Invoke-RestMethod -Uri "http://kong-proxy.local"

# Expected: "no Route matched with those values" (this is normal before creating routes)</code>
        </div>

        <div class="info">
            <strong>Success!</strong> If you can access these URLs without port-forwarding, your Ingress is configured correctly. Now let's register your API!
        </div>

        <h2>‚öôÔ∏è Step 4: Register Your API Service in Kong</h2>
        
        <div class="note">
            <strong>Important:</strong> All commands now use <code>http://kong-admin.local</code> instead of <code>http://localhost:8001</code>. No port-forwarding needed!
        </div>

        <h3>4.1. Create Kong Service (Register Upstream)</h3>
        <p>This tells Kong where your API is running inside the Kubernetes cluster.</p>
        
        <div class="code-block">
            <code>Invoke-RestMethod -Uri "http://kong-admin.local/services/" `
    -Method Post `
    -Body @{
        name="integratedapi-service"
        url="http://integratedapi-service.default.svc.cluster.local:7080"
    }</code>
        </div>
        
        <div class="response-block">
            <strong>What this does:</strong>
            <ul>
                <li>Creates a Kong Service named <code>integratedapi-service</code></li>
                <li>Points to your API at <code>integratedapi-service.default.svc.cluster.local:7080</code></li>
                <li>Kong will forward requests to this upstream service</li>
            </ul>
        </div>

        <h3>4.2. Verify Service Creation</h3>
        <div class="code-block">
            <code># List all services
Invoke-RestMethod -Uri "http://kong-admin.local/services/" | ConvertTo-Json -Depth 5

# Get specific service
Invoke-RestMethod -Uri "http://kong-admin.local/services/integratedapi-service" | ConvertTo-Json</code>
        </div>

        <h2>üõ£Ô∏è Step 5: Create Routes for Different Endpoints</h2>
        
        <p>Routes define how external requests map to your Kong Service. We'll create four routes:</p>

        <h3>5.1. API Endpoints Route (Preserve Path)</h3>
        <p>For endpoints like <code>/api/Employee/GetEmployees</code> - preserves the full path.</p>
        
        <div class="code-block">
            <code>Invoke-RestMethod -Uri "http://kong-admin.local/services/integratedapi-service/routes" `
    -Method POST `
    -ContentType 'application/json' `
    -Body (@{
        name="integratedapi-api-route"
        paths=@("/api")
        strip_path=$false
    } | ConvertTo-Json -Depth 4)</code>
        </div>
        
        <div class="response-block">
            <strong>Path Handling:</strong>
            <ul>
                <li><strong>Request:</strong> <code>http://kong-proxy.local/api/Employee/GetEmployees</code></li>
                <li><strong>Forwarded to:</strong> <code>http://integratedapi-service:7080/api/Employee/GetEmployees</code></li>
                <li><strong>strip_path = false:</strong> The full path is preserved</li>
            </ul>
        </div>

        <h3>5.2. Swagger/Docs Route (Strip Path)</h3>
        <p>For Swagger UI access - strips the <code>/integratedapi</code> prefix.</p>
        
        <div class="code-block">
            <code>Invoke-RestMethod -Uri "http://kong-admin.local/services/integratedapi-service/routes" `
    -Method POST `
    -ContentType 'application/json' `
    -Body (@{
        name="integratedapi-swagger-route"
        paths=@("/integratedapi")
        strip_path=$true
    } | ConvertTo-Json -Depth 4)</code>
        </div>
        
        <div class="response-block">
            <strong>Path Handling:</strong>
            <ul>
                <li><strong>Request:</strong> <code>http://kong-proxy.local/integratedapi/swagger/index.html</code></li>
                <li><strong>Forwarded to:</strong> <code>http://integratedapi-service:7080/swagger/index.html</code></li>
                <li><strong>strip_path = true:</strong> The <code>/integratedapi</code> prefix is removed</li>
            </ul>
        </div>

        <h3>5.3. Health Check Route (Preserve Path)</h3>
        <p>For health/readiness checks.</p>
        
        <div class="code-block">
            <code>Invoke-RestMethod -Uri "http://kong-admin.local/services/integratedapi-service/routes" `
    -Method POST `
    -ContentType 'application/json' `
    -Body (@{
        name="integratedapi-health-route"
        paths=@("/health")
        strip_path=$false
    } | ConvertTo-Json -Depth 4)</code>
        </div>
        
        <div class="response-block">
            <strong>Path Handling:</strong>
            <ul>
                <li><strong>Request:</strong> <code>http://kong-proxy.local/health</code></li>
                <li><strong>Forwarded to:</strong> <code>http://integratedapi-service:7080/health</code></li>
            </ul>
        </div>

        <h3>5.4. Weather Forecast Route (Preserve Path)</h3>
        <p>For the sample WeatherForecast endpoint.</p>
        
        <div class="code-block">
            <code>Invoke-RestMethod -Uri "http://kong-admin.local/services/integratedapi-service/routes" `
    -Method POST `
    -ContentType 'application/json' `
    -Body (@{
        name="integratedapi-weather-route"
        paths=@("/WeatherForecast")
        strip_path=$false
    } | ConvertTo-Json -Depth 4)</code>
        </div>

        <h3>5.5. Verify All Routes</h3>
        <div class="code-block">
            <code># List all routes for your service
Invoke-RestMethod -Uri "http://kong-admin.local/services/integratedapi-service/routes" | ConvertTo-Json -Depth 5

# Should show 4 routes: api-route, swagger-route, health-route, weather-route</code>
        </div>

        <h2>üß™ Step 6: Test Your API Through Kong</h2>
        
        <p>Now that routes are configured, test each endpoint through Kong Proxy!</p>

        <h3>6.1. Test Health Endpoint</h3>
        <div class="code-block">
            <code># PowerShell
Invoke-RestMethod -Uri "http://kong-proxy.local/health"

# Expected: "Healthy" or your health check response</code>
        </div>

        <h3>6.2. Test Weather Forecast Endpoint</h3>
        <div class="code-block">
            <code># PowerShell
Invoke-RestMethod -Uri "http://kong-proxy.local/WeatherForecast"

# Expected: JSON array of weather forecast data</code>
        </div>

        <h3>6.3. Test API Endpoint</h3>
        <div class="code-block">
            <code># PowerShell
Invoke-RestMethod -Uri "http://kong-proxy.local/api/Employee/GetEmployees"

# Expected: Your employee data from the database</code>
        </div>

        <h2>üìö Step 7: Access Swagger UI</h2>
        
        <div class="success">
            <h3>üéâ Open Swagger UI in Your Browser</h3>
            <p>Navigate to: <strong><code>http://kong-proxy.local/integratedapi/swagger/index.html</code></strong></p>
        </div>

        <h3>Using Swagger Through Kong</h3>
        <div class="code-block">
            <code># Option 1: Open in default browser
Start-Process "http://kong-proxy.local/integratedapi/swagger/index.html"

# Option 2: Test Swagger JSON endpoint
Invoke-RestMethod -Uri "http://kong-proxy.local/integratedapi/swagger/v1/swagger.json"</code>
        </div>

        <div class="info">
            <strong>Why does this work?</strong>
            <ul>
                <li>Your request: <code>http://kong-proxy.local/integratedapi/swagger/index.html</code></li>
                <li>Kong matches the <code>integratedapi-swagger-route</code></li>
                <li>Kong strips <code>/integratedapi</code> prefix (because strip_path=true)</li>
                <li>Kong forwards: <code>/swagger/index.html</code> to your API</li>
                <li>Your API serves the Swagger UI</li>
            </ul>
        </div>

        <h3>Testing API Endpoints from Swagger</h3>
        <p>When using Swagger UI through Kong, all API calls will automatically go through Kong Proxy!</p>
        
        <ol>
            <li>Open Swagger UI at <code>http://kong-proxy.local/integratedapi/swagger/index.html</code></li>
            <li>Swagger will show all your API endpoints (Employee, etc.)</li>
            <li>Click "Try it out" on any endpoint</li>
            <li>Execute the request</li>
            <li>Swagger will make the request through Kong Proxy</li>
        </ol>

        <h2>üìä Complete Endpoint Reference</h2>
        
        <table>
            <thead>
                <tr>
                    <th>Purpose</th>
                    <th>Public URL (via Kong Proxy)</th>
                    <th>Route Name</th>
                    <th>Strip Path?</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Swagger UI</strong></td>
                    <td><code>http://kong-proxy.local/integratedapi/swagger/index.html</code></td>
                    <td><code>integratedapi-swagger-route</code></td>
                    <td>‚úÖ TRUE</td>
                </tr>
                <tr>
                    <td><strong>Swagger JSON</strong></td>
                    <td><code>http://kong-proxy.local/integratedapi/swagger/v1/swagger.json</code></td>
                    <td><code>integratedapi-swagger-route</code></td>
                    <td>‚úÖ TRUE</td>
                </tr>
                <tr>
                    <td><strong>API Endpoints</strong></td>
                    <td><code>http://kong-proxy.local/api/Employee/GetEmployees</code></td>
                    <td><code>integratedapi-api-route</code></td>
                    <td>‚ùå FALSE</td>
                </tr>
                <tr>
                    <td><strong>Health Check</strong></td>
                    <td><code>http://kong-proxy.local/health</code></td>
                    <td><code>integratedapi-health-route</code></td>
                    <td>‚ùå FALSE</td>
                </tr>
                <tr>
                    <td><strong>Weather API</strong></td>
                    <td><code>http://kong-proxy.local/WeatherForecast</code></td>
                    <td><code>integratedapi-weather-route</code></td>
                    <td>‚ùå FALSE</td>
                </tr>
            </tbody>
        </table>

        <h2>üîß Useful Management Commands</h2>

        <h3>View Kong Configuration</h3>
        <div class="code-block">
            <code># List all services
Invoke-RestMethod -Uri "http://kong-admin.local/services" | ConvertTo-Json -Depth 3

# List all routes
Invoke-RestMethod -Uri "http://kong-admin.local/routes" | ConvertTo-Json -Depth 3

# Get service details
Invoke-RestMethod -Uri "http://kong-admin.local/services/integratedapi-service" | ConvertTo-Json

# Get route details
Invoke-RestMethod -Uri "http://kong-admin.local/routes/integratedapi-api-route" | ConvertTo-Json</code>
        </div>

        <h3>Update a Route</h3>
        <div class="code-block">
            <code># Example: Update strip_path setting
Invoke-RestMethod -Uri "http://kong-admin.local/routes/integratedapi-swagger-route" `
    -Method PATCH `
    -ContentType 'application/json' `
    -Body (@{strip_path=$false} | ConvertTo-Json)</code>
        </div>

        <h3>Delete a Route</h3>
        <div class="code-block">
            <code># Delete a route by name
Invoke-RestMethod -Uri "http://kong-admin.local/routes/integratedapi-weather-route" -Method DELETE</code>
        </div>

        <h3>Delete a Service (and all its routes)</h3>
        <div class="code-block">
            <code># This will also delete all routes associated with the service
Invoke-RestMethod -Uri "http://kong-admin.local/services/integratedapi-service" -Method DELETE</code>
        </div>

        <h2>üóÑÔ∏è Final Configuration State</h2>
        <p>Summary of all Kong resources created:</p>
        <table>
            <thead>
                <tr>
                    <th>Resource Type</th>
                    <th>Name</th>
                    <th>Host/Paths</th>
                    <th>Strip Path</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Service</strong></td>
                    <td><code>integratedapi-service</code></td>
                    <td><code>integratedapi-service.default.svc.cluster.local:7080</code></td>
                    <td>N/A</td>
                </tr>
                <tr>
                    <td><strong>Route</strong></td>
                    <td><code>integratedapi-api-route</code></td>
                    <td>Paths: <code>/api</code></td>
                    <td><strong><code>false</code></strong></td>
                </tr>
                <tr>
                    <td><strong>Route</strong></td>
                    <td><code>integratedapi-swagger-route</code></td>
                    <td>Paths: <code>/integratedapi</code></td>
                    <td><strong><code>true</code></strong></td>
                </tr>
                <tr>
                    <td><strong>Route</strong></td>
                    <td><code>integratedapi-health-route</code></td>
                    <td>Paths: <code>/health</code></td>
                    <td><strong><code>false</code></strong></td>
                </tr>
                <tr>
                    <td><strong>Route</strong></td>
                    <td><code>integratedapi-weather-route</code></td>
                    <td>Paths: <code>/WeatherForecast</code></td>
                    <td><strong><code>false</code></strong></td>
                </tr>
                <tr>
                    <td><strong>Ingress</strong></td>
                    <td><code>kong-admin-ingress</code></td>
                    <td>Host: <code>kong-admin.local</code></td>
                    <td>N/A</td>
                </tr>
                <tr>
                    <td><strong>Ingress</strong></td>
                    <td>kong-proxy-ingress</code></td>
                    <td>Host: <code>kong-proxy.local</code></td>
                    <td>N/A</td>
                </tr>
            </tbody>
        </table>

        <h2>üéØ Benefits of This Setup</h2>
        <div class="info">
            <ul>
                <li><strong>No Port-Forwarding Required:</strong> Access Kong Admin and Proxy directly via domain names</li>
                <li><strong>Production-Ready:</strong> Ingress is the standard way to expose services in Kubernetes</li>
                <li><strong>Clean URLs:</strong> Use friendly domain names instead of localhost:port</li>
                <li><strong>Easy API Testing:</strong> Swagger UI works seamlessly through Kong</li>
                <li><strong>Scalable:</strong> Easy to add SSL/TLS certificates and additional routing rules</li>
                <li><strong>Centralized Gateway:</strong> All API traffic flows through Kong for monitoring, rate limiting, authentication</li>
            </ul>
        </div>

        <h2>üîç Troubleshooting</h2>
        
        <h3>Issue: Cannot reach kong-admin.local or kong-proxy.local</h3>
        <div class="code-block">
            <code># Check Ingress status
kubectl get ingress -n kong

# Check Ingress Controller pods
kubectl get pods -n ingress-nginx

# Describe Ingress for details
kubectl describe ingress kong-admin-ingress -n kong

# Check Kong service
kubectl get svc -n kong</code>
        </div>

        <h3>Issue: Ingress shows no ADDRESS</h3>
        <p>Wait a few minutes for the Ingress Controller to assign an address. For local clusters (Docker Desktop/Minikube), the address should be <code>localhost</code>.</p>

        <h3>Issue: 404 Not Found when accessing kong-admin.local</h3>
        <div class="code-block">
            <code># Verify hosts file was updated correctly
# Windows: